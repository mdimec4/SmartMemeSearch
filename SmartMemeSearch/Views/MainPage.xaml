<Page
    x:Class="SmartMemeSearch.Views.MainPage"
    xmlns:model="using:SmartMemeSearch"
    xmlns:conv="using:SmartMemeSearch.Converters"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="using:SmartMemeSearch.ViewModels"
    Loaded="Page_Loaded">

    <Page.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <conv:BoolToIndeterminateConverter x:Key="BoolToIndeterminateConverter"/>
        <MenuFlyout x:Key="MemeFlyout">
            <MenuFlyoutItem Text="Open" Click="OpenItem_Click"/>
            <MenuFlyoutItem Text="Copy image" Click="CopyImageMenu_Click"/>
            <MenuFlyoutItem Text="Copy file" Click="CopyFileMenu_Click"/>
            <MenuFlyoutItem Text="Copy file path" Click="CopyPathMenu_Click"/>
            <MenuFlyoutItem Text="Open folder" Click="OpenFolderMenu_Click"/>
        </MenuFlyout>
    </Page.Resources>

    <Page.DataContext>
        <vm:MainViewModel />
    </Page.DataContext>

    <Grid Padding="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Search box -->
        <StackPanel Orientation="Horizontal" Spacing="8">
            <TextBox Width="400"
                PlaceholderText="Search memes..."
                Text="{Binding Query, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

            <Button Content="Manage Meme Folders"
                Command="{Binding ManageFoldersCommand}"/>
        </StackPanel>
        <StackPanel Grid.Row="1" Margin="0,10,0,0">
            <ProgressBar Minimum="0" 
                 Maximum="1" 
                 Value="{Binding ProgressValue}" 
                 IsIndeterminate="{Binding IsImporting, Converter={StaticResource BoolToIndeterminateConverter}}"/>

            <TextBlock Text="{Binding CurrentFile}"
               FontSize="12"
               Foreground="Gray"
               TextWrapping="Wrap"/>

            <TextBlock Text="Importing..."
               Visibility="{Binding IsImporting, Converter={StaticResource BoolToVisibilityConverter}}"
               Foreground="DarkOrange"/>
        </StackPanel>

        <!-- Results -->
        <ListView Grid.Row="2"
          ItemsSource="{Binding Results}"
          Margin="0,20,0,0"
          x:Name="ResultsList">

            <ListView.KeyboardAccelerators>

                    <!-- Enter = Open -->
                    <KeyboardAccelerator Key="Enter"
                             Invoked="Open_KA_Invoked"/>

                    <!-- Ctrl+C = Copy image -->
                    <KeyboardAccelerator Key="C"
                             Modifiers="Control"
                             Invoked="CopyImage_KA_Invoked"/>

                    <!-- OPTIONAL: Ctrl+Shift+C = Copy file path -->
                    <KeyboardAccelerator Key="C"
                             Modifiers="Control,Shift"
                             Invoked="CopyPath_KA_Invoked"/>

                </ListView.KeyboardAccelerators>
                
                <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>

                    <!-- hover effect -->
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <Grid x:Name="RootGrid" Background="Transparent">

                                    <VisualStateManager.VisualStateGroups>
                                        <VisualStateGroup x:Name="CommonStates">

                                            <VisualState x:Name="Normal" />

                                            <VisualState x:Name="PointerOver">
                                                <VisualState.Setters>
                                                    <Setter Target="RootGrid.Background"
                                                    Value="#22000000"/>
                                                </VisualState.Setters>
                                            </VisualState>

                                            <VisualState x:Name="Pressed">
                                                <VisualState.Setters>
                                                    <Setter Target="RootGrid.Background"
                                                    Value="#33000000"/>
                                                </VisualState.Setters>
                                            </VisualState>

                                        </VisualStateGroup>
                                    </VisualStateManager.VisualStateGroups>

                                    <ContentPresenter
                                HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                Margin="4"/>
                                </Grid>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>

                </Style>
            </ListView.ItemContainerStyle>

            <!-- ItemTemplate from step 1 here -->
            <ListView.ItemTemplate>
                <DataTemplate x:DataType="model:SearchResult">
                    <Grid
                        Background="Transparent"
                        DoubleTapped="ResultItem_DoubleTapped"
                        ContextFlyout="{StaticResource MemeFlyout}"
                        Padding="4">

                        <StackPanel Orientation="Horizontal" Spacing="12">

                            <Image Source="{Binding Thumbnail}"
                               Width="120" Height="120"
                               Stretch="UniformToFill"
                               Margin="0,0,8,0"/>

                            <StackPanel>
                                <TextBlock Text="{x:Bind FilePath}" FontSize="14"/>
                                <TextBlock Text="{x:Bind Score}" FontSize="12" Foreground="Gray"/>
                                <TextBlock Text="{x:Bind OcrPreview}"
                                   TextWrapping="Wrap"
                                   FontSize="12"
                                   Foreground="#666"/>
                            </StackPanel>

                        </StackPanel>
                    </Grid>
                </DataTemplate>
            </ListView.ItemTemplate>

        </ListView>

    </Grid>
</Page>
