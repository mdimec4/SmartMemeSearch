<Window x:Class="SmartMemeSearch.Wpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:SmartMemeSearch.Wpf.ViewModels"
        xmlns:conv="clr-namespace:SmartMemeSearch.Wpf.Converters"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        Title="Smart Meme Search"
        Width="1200"
        Height="800"
        WindowStartupLocation="CenterScreen"
        KeyDown="Window_KeyDown">

    <Window.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <conv:BoolToVisibilityInverseConverter x:Key="BoolToVisibilityInverseConverter" />
        <!-- Add your other converters -->

        <!-- ContextMenu instead of WinUI MenuFlyout -->
        <ContextMenu x:Key="MemeContextMenu">
            <MenuItem Header="Open" Click="OpenItem_Click"/>
            <MenuItem Header="Copy image" Click="CopyImageMenu_Click"/>
            <MenuItem Header="Copy file" Click="CopyFileMenu_Click"/>
            <MenuItem Header="Copy file path" Click="CopyPathMenu_Click"/>
            <MenuItem Header="Open folder" Click="OpenFolderMenu_Click"/>
        </ContextMenu>
    </Window.Resources>

    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <DockPanel>
        <!-- Search bar -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="8">
            <TextBox x:Name="SearchBox"
                     Width="400"
                     Margin="0,0,8,0"
                     VerticalAlignment="Center"
                     Text="{Binding Query, UpdateSourceTrigger=PropertyChanged}"
                     PreviewKeyDown="SearchBox_KeyDown"/>
            <Button Content="Manage Meme Folders"
                    Width="80"
                    Click="ManageFolders_Click"/>
            <Button Content="Remove Adds"
                    Width="80"
                    Click="RemoveAdds_Click"/>
        </StackPanel>

        <!-- Main content -->
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Meme grid -->
            <ListBox x:Name="ResultsList" 
                ItemsSource="{Binding Results}"
                BorderThickness="0"
                ScrollViewer.VerticalScrollBarVisibility="Auto"
                HorizontalContentAlignment="Stretch"
                KeyDown="ResultsList_KeyDown"
                MouseDoubleClick="ResultsList_MouseDoubleClick">

                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Vertical"/>
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>

                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Margin="4"
                Height="200"
                BorderBrush="Gray"
                BorderThickness="1"
                CornerRadius="4"
                HorizontalAlignment="Stretch">

                            <Border.ContextMenu>
                                <StaticResource ResourceKey="MemeContextMenu" />
                            </Border.ContextMenu>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="202"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- Thumbnail -->
                                <Image Source="{Binding Thumbnail}"
                                       Width="200"
                                       Height="200"
                                       Grid.Row="0"
                                       Grid.Column="0"
                                       Stretch="UniformToFill"/>

                                <!-- Text area -->
                                <StackPanel Grid.Column="1"
                                        Margin="8"
                                        VerticalAlignment="Top"
                                        Orientation="Vertical">

                                    <!-- File path -->
                                    <TextBlock Text="{Binding FilePath}"
                                           TextWrapping="NoWrap"
                                           TextTrimming="CharacterEllipsis"
                                           FontWeight="Bold"/>

                                    <!-- Score -->
                                    <TextBlock Text="{Binding Score}"
                               Margin="0,4,0,0"/>

                                    <!-- OCR preview -->
                                    <TextBlock Text="{Binding OcrPreview}"
                                            TextWrapping="Wrap"
                                            TextTrimming="CharacterEllipsis"
                                            MaxHeight="60">

                                        <TextBlock.ToolTip>
                                            <Border Padding="8" MaxWidth="500">
                                                <TextBlock Text="{Binding OcrPreview}"
                                                        TextWrapping="Wrap"/>
                                            </Border>
                                        </TextBlock.ToolTip>

</TextBlock>
                                    <!-- prevents overflow -->

                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>


            </ListBox>
            <!-- Ads area (WebView2) -->
            <Border Grid.Row="1"
                    Margin="8,4,8,8"
                    Padding="0"
                    Visibility="{Binding IsPremium, Converter={StaticResource BoolToVisibilityInverseConverter}}">
                <wv2:WebView2 x:Name="AdsView"
                              xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
                              Height="80" />
            </Border>
        </Grid>
    </DockPanel>
</Window>
